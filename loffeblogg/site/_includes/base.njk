<!DOCTYPE html>
<html lang="nn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if isPost %}{{ post.title }} - {% elif title %}{{ title }} - {% endif %}Loffetur</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body id="top">
  <header class="site-header">
    <nav>
      <a href="/" class="site-title">Loffetur</a>
      {% if not showHero %}<span class="site-tagline">90 dagar frå Thailand til Australia</span>{% endif %}
    </nav>
  </header>

  {% if showHero %}
  <section class="hero">
    <div class="hero-content">
      <h1>Loffetur</h1>
      <p class="tagline">Skjalg og Unni Elisabeth er på loffetur i rundt 90 dagar. Frå Thailand i nord til Australia i sør. Store delar av turen vert til undervegs.</p>
    </div>
  </section>
  {% endif %}

  <main>
    {{ content | safe }}
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <nav class="footer-route">
        {% for p in posts | reverse %}
        {# Check if post has images (content) #}
        {% set hasImages = false %}
        {% for day in p.days %}
          {% if day.images and day.images.length > 0 %}
            {% set hasImages = true %}
          {% endif %}
        {% endfor %}
        
        {% if isPost and p.slug == post.slug %}
        <span class="route-stop">{{ p.title }}</span>
        {% elif hasImages %}
        <a href="/{{ p.slug }}/" class="route-stop">{{ p.title }}</a>
        {% else %}
        <span class="route-stop route-stop-future">{{ p.title }}</span>
        {% endif %}
        {% if not loop.last %}<span class="route-arrow">→</span>{% endif %}
        {% endfor %}
      </nav>
      <p class="footer-links"><a href="/">Heim</a> · <a href="#top">Til toppen ↑</a></p>
    </div>
  </footer>

  <script>
    // Hide header on scroll down, show on scroll up
    let lastScroll = 0;
    const header = document.querySelector('.site-header');

    window.addEventListener('scroll', () => {
      const currentScroll = window.scrollY;

      if (currentScroll <= 0) {
        header.classList.remove('hidden');
        return;
      }

      if (currentScroll > lastScroll && currentScroll > 60) {
        header.classList.add('hidden');
      } else if (currentScroll < lastScroll) {
        header.classList.remove('hidden');
      }

      lastScroll = currentScroll;
    }, { passive: true });

    {% if isPost %}
    // Day navigation - scroll tracking and mobile dropdown
    (function() {
      const dayNav = document.querySelector('.day-nav');
      const dayIndicator = document.querySelector('.day-indicator');
      const indicatorText = document.querySelector('.indicator-text');
      const daySections = document.querySelectorAll('.day-section[data-day]');
      const navItems = document.querySelectorAll('.day-nav li');

      if (!dayNav || !daySections.length) return;

      // Build data for indicator text
      const dayData = [];
      navItems.forEach((item, i) => {
        const link = item.querySelector('a');
        const date = link.querySelector('.date')?.textContent || '';
        const location = link.querySelector('.location')?.textContent || '';
        dayData.push({ date, location });
      });

      // Update active day in nav and indicator
      function setActiveDay(dayNum) {
        navItems.forEach((item, i) => {
          item.classList.toggle('active', i + 1 === dayNum);
        });

        if (indicatorText && dayData[dayNum - 1]) {
          const data = dayData[dayNum - 1];
          indicatorText.textContent = data.location
            ? `${data.date} · ${data.location}`
            : data.date;
        }
      }

      // Intersection Observer for scroll tracking
      let currentDay = 1;
      const observerOptions = {
        root: null,
        rootMargin: '-20% 0px -60% 0px',
        threshold: 0
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const dayNum = parseInt(entry.target.dataset.day, 10);
            if (dayNum && dayNum !== currentDay) {
              currentDay = dayNum;
              setActiveDay(dayNum);
            }
          }
        });
      }, observerOptions);

      daySections.forEach(section => observer.observe(section));

      // Initialize active state
      setActiveDay(1);

      // Mobile dropdown toggle
      if (dayIndicator) {
        dayIndicator.addEventListener('click', () => {
          const isOpen = dayNav.classList.toggle('open');
          dayIndicator.setAttribute('aria-expanded', isOpen);
        });

        // Close dropdown when clicking a link
        dayNav.addEventListener('click', (e) => {
          if (e.target.closest('a')) {
            dayNav.classList.remove('open');
            dayIndicator.setAttribute('aria-expanded', 'false');
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.day-sidebar')) {
            dayNav.classList.remove('open');
            dayIndicator.setAttribute('aria-expanded', 'false');
          }
        });
      }
    })();
    {% endif %}
  </script>
</body>
</html>
